<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Article Stories</title>
  <style>
    html, body, #root { height: 100%; margin: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="module">
    import React from 'https://esm.sh/react@18';
    import { createRoot } from 'https://esm.sh/react-dom@18/client';
    import Stories from 'https://esm.sh/react-insta-stories@3';

    async function load() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');
      if (!slug) return;
      const res = await fetch(`/api/articles?filters[slug][$eq]=${slug}&populate=blocks,cover`);
      const { data } = await res.json();
      if (!data.length) return;
      const article = data[0].attributes;
      const stories = [];
      if (article.cover?.data?.attributes?.url) {
        stories.push({ url: article.cover.data.attributes.url });
      }
      (article.blocks || []).forEach(block => {
        if (block.__component === 'shared.media') {
          const url = block.file?.data?.attributes?.url;
          if (url) stories.push({ url });
        }
        if (block.__component === 'shared.slider') {
          (block.files?.data || []).forEach(m => {
            const url = m.attributes?.url;
            if (url) stories.push({ url });
          });
        }
      });
      createRoot(document.getElementById('root')).render(
        React.createElement(Stories, { stories })
      );
    }
    load();
  </script>
</body>
</html>
